<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wo war Raffael schon?</title>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 85vh;
        }
        #legend {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 8px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            font-size: 12px;
            z-index: 1000;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            display: inline-block;
            margin-right: 5px;
            border-radius: 50%;
        }
        #controls {
            padding: 10px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #ddd;
            text-align: center;
        }
        #updateButton {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        #updateButton:hover {
            background-color: #45a049;
        }
        #status {
            margin-left: 10px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="controls">
        <button id="updateButton">Karte aktualisieren</button>
        <span id="status"></span>
    </div>
    
    <div id="legend">
        <strong>Orte, wo ich schon mal war (gezählt ab einer Übernachtung)</strong>
        <div class="legend-item"><span class="legend-color" style="background: #FFC0CB;"></span> Baby (0-1 Jahre)</div>
        <div class="legend-item"><span class="legend-color" style="background: #FFCC99;"></span> Mini Kind (2-3 Jahre)</div>
        <div class="legend-item"><span class="legend-color" style="background: #FFEB3B;"></span> Entdeckerzeit (4-6 Jahre)</div>
        <div class="legend-item"><span class="legend-color" style="background: #AED581;"></span> Kinderabenteuer (7-9 Jahre)</div>
        <div class="legend-item"><span class="legend-color" style="background: #4DD0E1;"></span> Große Kindheit (10-12 Jahre)</div>
        <div class="legend-item"><span class="legend-color" style="background: #64B5F6;"></span> Frühe Jugend (13-15 Jahre)</div>
        <div class="legend-item"><span class="legend-color" style="background: #9575CD;"></span> Späte Jugend (16-17 Jahre)</div>
        <div class="legend-item"><span class="legend-color" style="background: #5E35B1;"></span> Junge Zukunft (ab 18 Jahre)</div>
    </div>
    
    <div id="map"></div>
    
    <script>
        // Globale Variablen
        var map;
        var markers = [];
        
        // Funktion zum Hinzufügen eines Markers
        function addMarker(pin) {
            var farbe;
            
            // Neue Kategorien mit Altern und Farben
            if (pin.alter <= 1) {
                farbe = '#FFC0CB'; // Pastell Rosa
            } else if (pin.alter <= 3) {
                farbe = '#FFCC99'; // Hellorange
            } else if (pin.alter <= 6) {
                farbe = '#FFEB3B'; // Sonnengelb
            } else if (pin.alter <= 9) {
                farbe = '#AED581'; // Hellgrün
            } else if (pin.alter <= 12) {
                farbe = '#4DD0E1'; // Türkis
            } else if (pin.alter <= 15) {
                farbe = '#64B5F6'; // Himmelblau
            } else if (pin.alter <= 17) {
                farbe = '#9575CD'; // Violett
            } else {
                farbe = '#5E35B1'; // Dunkles Violett für ab 18
            }
            
            // Farbiger Marker erstellen
            var coloredIcon = L.divIcon({
                className: 'colored-marker',
                html: `<svg width="25" height="41" viewBox="0 0 25 41" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.5 0C5.596 0 0 5.596 0 12.5C0 19.404 12.5 41 12.5 41S25 19.404 25 12.5C25 5.596 19.404 0 12.5 0Z" 
                        fill="${farbe}" />
                    <circle cx="12.5" cy="12.5" r="5" fill="white" />
                </svg>`,
                iconSize: [25, 41],
                iconAnchor: [12.5, 41],
                popupAnchor: [0, -41]
            });
            
            // Marker erstellen und zur Karte hinzufügen
            var marker = L.marker([pin.lat, pin.lng], { icon: coloredIcon })
                .addTo(map)
                .bindPopup("Alter: " + pin.alter);
            
            // Marker zum Array hinzufügen (für späteres Entfernen)
            markers.push(marker);
        }
        
        // Funktion zum Laden und Aktualisieren der Karte
        function updateMap() {
            updateStatus("Lade Daten...");
            
            // Alle bestehenden Marker entfernen
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // JSON laden mit einem Cache-Brecher-Parameter, um Cache-Probleme zu vermeiden
            fetch('orte.json?v=' + new Date().getTime())
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Konnte JSON-Datei nicht laden: ' + response.status);
                    }
                    return response.json();
                })
                .then(pins => {
                    // Wenn wir hierher kommen, wurde die JSON erfolgreich geladen
                    console.log('JSON-Datei erfolgreich geladen:', pins.length + ' Orte gefunden');
                    pins.forEach(addMarker);
                    updateStatus("Zuletzt aktualisiert: " + new Date().toLocaleTimeString());
                })
                .catch(error => {
                    console.error('Fehler beim Laden der JSON-Datei:', error);
                    updateStatus("Fehler beim Laden. Bitte erneut versuchen.");
                    
                    // Fallback-Daten für Testzwecke
                    var fallbackPins = [
                        { "lat": 48.25940, "lng": 7.72310, "alter": 14 }
                    ];
                    fallbackPins.forEach(addMarker);
                });
        }
        
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // Warte, bis die Seite vollständig geladen ist
        document.addEventListener('DOMContentLoaded', function() {
            // Karteninitialisierung
            map = L.map('map').setView([20, 0], 2); // Weltkarte als Standardansicht
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap-Mitwirkende'
            }).addTo(map);
            
            // Karte initial laden
            updateMap();
            
            // Event-Listener für den Update-Button
            document.getElementById('updateButton').addEventListener('click', function() {
                updateMap();
            });
        });
    </script>
    <footer style="text-align: center;">
        <p>&copy; 2025 Raffael Bauer. Alle Rechte vorbehalten.</p>
        <p>
            <a href="https://raffaelbauer.github.io/Datenschutzerklaerung/">Datenschutzbestimmungen</a>
        </p>
    </footer>
</body>
</html>
